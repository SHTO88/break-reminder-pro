<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Break Time</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      html, body {
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        position: fixed;
        top: 0;
        left: 0;
      }

      body {
        background: #000;
        color: #fff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        cursor: default; /* Changed from none to default for better UX */
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
      }

      .break-container {
        text-align: center;
        position: relative;
        z-index: 10;
      }

      .progress-ring {
        position: relative;
        width: 200px;
        height: 200px;
        margin: 0 auto 2rem;
      }

      .progress-ring-circle {
        width: 100%;
        height: 100%;
        fill: none;
        stroke: #333;
        stroke-width: 8;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
      }

      .progress-ring-progress {
        fill: none;
        stroke: #4ade80;
        stroke-width: 8;
        stroke-linecap: round;
        transform: rotate(-90deg);
        transform-origin: 50% 50%;
        transition: stroke-dashoffset 1s linear;
      }

      .countdown-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 2.5rem;
        font-weight: 700;
        color: #4ade80;
        font-family: 'Courier New', monospace;
      }

      .break-title {
        font-size: 2rem;
        font-weight: 300;
        margin-bottom: 1rem;
        color: #888;
      }

      .break-message {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 3rem;
        max-width: 500px;
        line-height: 1.5;
      }

      .unlock-container {
        position: fixed;
        bottom: 50px;
        left: 50%;
        transform: translateX(-50%);
      }

      .unlock-btn {
        background: rgba(255, 255, 255, 0.1);
        border: 2px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 12px 24px;
        border-radius: 25px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
      }

      .unlock-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        border-color: rgba(255, 255, 255, 0.4);
        transform: translateY(-2px);
      }

      /* Math Problem Modal */
      .math-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.9);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
      }

      .math-modal.show {
        display: flex;
      }

      .math-content {
        background: #111;
        border: 2px solid #333;
        border-radius: 15px;
        padding: 3rem;
        text-align: center;
        max-width: 400px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
      }

      .math-title {
        font-size: 1.5rem;
        margin-bottom: 2rem;
        color: #4ade80;
      }

      .math-problem {
        font-size: 2rem;
        font-weight: 600;
        margin-bottom: 2rem;
        color: #fff;
        font-family: 'Courier New', monospace;
      }

      .math-input {
        background: #222;
        border: 2px solid #444;
        border-radius: 8px;
        padding: 15px;
        font-size: 1.5rem;
        color: #fff;
        text-align: center;
        width: 120px;
        margin: 0 auto;
        display: block;
      }

      .math-input:focus {
        outline: none;
        border-color: #4ade80;
        box-shadow: 0 0 10px rgba(74, 222, 128, 0.3);
      }

      .math-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
      }

      .math-btn {
        background: #4ade80;
        border: none;
        color: #000;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .math-btn:hover {
        background: #22c55e;
        transform: translateY(-1px);
      }

      .math-btn.cancel {
        background: #666;
        color: #fff;
      }

      .math-btn.cancel:hover {
        background: #555;
      }

      .math-error {
        color: #ef4444;
        margin-top: 1rem;
        font-size: 0.9rem;
      }

      .hidden {
        display: none !important;
      }

      /* Fade in animation */
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .break-container {
        animation: fadeIn 0.5s ease-out;
      }

      /* Ensure fullscreen coverage */
      @media screen {
        html, body {
          background: #000 !important;
          width: 100vw !important;
          height: 100vh !important;
          margin: 0 !important;
          padding: 0 !important;
          border: none !important;
          outline: none !important;
        }
      }

      /* Hide cursor during focus mode (can be toggled) */
      .focus-mode {
        cursor: none !important;
      }

      .focus-mode * {
        cursor: none !important;
      }

      /* Instructions for early return */
      .instructions {
        position: fixed;
        top: 30px;
        right: 30px;
        background: rgba(0, 0, 0, 0.7);
        color: #888;
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 0.8rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        opacity: 0;
        animation: fadeInLater 2s ease-out 3s forwards;
      }

      @keyframes fadeInLater {
        from { opacity: 0; }
        to { opacity: 1; }
      }
    </style>
  </head>
  <body>
    <div class="instructions">
      Press 'F' to toggle focus mode (hide cursor)<br>
      ESC to show/hide early return option
    </div>

    <div class="break-container">
      <h1 class="break-title">Time for a Break</h1>
      <div class="progress-ring">
        <svg width="200" height="200">
          <circle
            class="progress-ring-circle"
            cx="100"
            cy="100"
            r="90"
          ></circle>
          <circle
            class="progress-ring-progress"
            cx="100"
            cy="100"
            r="90"
            id="progress-circle"
          ></circle>
        </svg>
        <div class="countdown-text" id="countdown-display">--:--</div>
      </div>
      <p class="break-message">
        Step away from your screen and give your eyes and mind a rest. Your health matters more than any deadline.
      </p>
    </div>

    <div class="unlock-container" id="unlock-container" style="display: none;">
      <button class="unlock-btn" id="unlock-btn">Early Return</button>
    </div>

    <!-- Math Problem Modal -->
    <div class="math-modal" id="math-modal">
      <div class="math-content">
        <h2 class="math-title">Solve to Continue</h2>
        <div class="math-problem" id="math-problem">2 + 2 = ?</div>
        <input
          type="number"
          class="math-input"
          id="math-input"
          placeholder="?"
          autocomplete="off"
        />
        <div class="math-error hidden" id="math-error">
          Incorrect answer. Try again.
        </div>
        <div class="math-buttons">
          <button class="math-btn" id="math-submit">Submit</button>
          <button class="math-btn cancel" id="math-cancel">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      console.log('Force break window HTML loaded successfully!');
      document.title = 'Force Break - LOADED';
      
      const { invoke } = window.__TAURI__.core;
      
      // Get break duration from settings (fallback to 5 minutes)
      let totalSeconds = 300; // 5 minutes default
      let currentSeconds = totalSeconds;
      let timerInterval = null;
      let focusMode = false;
      let earlyReturnVisible = false;
      
      // Math problem variables
      let currentAnswer = 0;
      
      // DOM elements
      const countdownDisplay = document.getElementById('countdown-display');
      const progressCircle = document.getElementById('progress-circle');
      const unlockBtn = document.getElementById('unlock-btn');
      const unlockContainer = document.getElementById('unlock-container');
      const mathModal = document.getElementById('math-modal');
      const mathProblem = document.getElementById('math-problem');
      const mathInput = document.getElementById('math-input');
      const mathError = document.getElementById('math-error');
      const mathSubmit = document.getElementById('math-submit');
      const mathCancel = document.getElementById('math-cancel');

      // Calculate circle circumference
      const radius = 90;
      const circumference = 2 * Math.PI * radius;

      // Initialize progress circle
      function initProgressCircle() {
        progressCircle.style.strokeDasharray = circumference;
        progressCircle.style.strokeDashoffset = 0;
      }

      // Update progress circle
      function updateProgress() {
        const progress = (totalSeconds - currentSeconds) / totalSeconds;
        const offset = circumference - (progress * circumference);
        progressCircle.style.strokeDashoffset = offset;
      }

      // Format time display
      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const remainingSeconds = seconds % 60;
        return `${minutes.toString().padStart(2, '0')}:${remainingSeconds.toString().padStart(2, '0')}`;
      }

      // Update countdown display
      function updateCountdown() {
        countdownDisplay.textContent = formatTime(currentSeconds);
        updateProgress();
        
        if (currentSeconds <= 0) {
          endBreak();
        } else {
          currentSeconds--;
        }
      }

      // Start the countdown timer
      function startTimer() {
        updateCountdown();
        timerInterval = setInterval(updateCountdown, 1000);
      }

      // Toggle focus mode (hide/show cursor)
      function toggleFocusMode() {
        focusMode = !focusMode;
        if (focusMode) {
          document.body.classList.add('focus-mode');
          console.log('Focus mode ON - cursor hidden');
        } else {
          document.body.classList.remove('focus-mode');
          console.log('Focus mode OFF - cursor visible');
        }
      }

      // Toggle early return button visibility
      function toggleEarlyReturn() {
        earlyReturnVisible = !earlyReturnVisible;
        unlockContainer.style.display = earlyReturnVisible ? 'block' : 'none';
        console.log('Early return button:', earlyReturnVisible ? 'visible' : 'hidden');
      }

      // End break and close window
      async function endBreak() {
        if (timerInterval) {
          clearInterval(timerInterval);
        }
        
        try {
          // Close the current window
          await invoke('close_window', { label: 'force_break' });
        } catch (error) {
          console.error('Error closing window:', error);
          // Fallback: hide the window
          window.close();
        }
      }

      // Generate random math problem
      function generateMathProblem() {
        const operations = ['+', '-', '×'];
        const operation = operations[Math.floor(Math.random() * operations.length)];
        
        let num1, num2;
        
        switch (operation) {
          case '+':
            num1 = Math.floor(Math.random() * 50) + 1;
            num2 = Math.floor(Math.random() * 50) + 1;
            currentAnswer = num1 + num2;
            break;
          case '-':
            num1 = Math.floor(Math.random() * 50) + 20;
            num2 = Math.floor(Math.random() * num1);
            currentAnswer = num1 - num2;
            break;
          case '×':
            num1 = Math.floor(Math.random() * 12) + 1;
            num2 = Math.floor(Math.random() * 12) + 1;
            currentAnswer = num1 * num2;
            break;
        }
        
        mathProblem.textContent = `${num1} ${operation} ${num2} = ?`;
      }

      // Show math modal
      function showMathModal() {
        generateMathProblem();
        mathInput.value = '';
        mathError.classList.add('hidden');
        mathModal.classList.add('show');
        
        // Focus on input
        setTimeout(() => {
          mathInput.focus();
        }, 100);
      }

      // Hide math modal
      function hideMathModal() {
        mathModal.classList.remove('show');
      }

      // Check math answer
      function checkAnswer() {
        const userAnswer = parseInt(mathInput.value);
        
        if (userAnswer === currentAnswer) {
          // Correct answer - end break
          hideMathModal();
          endBreak();
        } else {
          // Wrong answer - show error
          mathError.classList.remove('hidden');
          mathInput.value = '';
          mathInput.focus();
          
          // Generate new problem after wrong answer
          setTimeout(() => {
            generateMathProblem();
            mathError.classList.add('hidden');
          }, 1500);
        }
      }

      // Event listeners
      unlockBtn.addEventListener('click', showMathModal);
      mathSubmit.addEventListener('click', checkAnswer);
      mathCancel.addEventListener('click', hideMathModal);

      // Handle Enter key in math input
      mathInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          checkAnswer();
        }
      });

      // Enhanced keyboard controls
      document.addEventListener('keydown', (e) => {
        // Handle Escape key
        if (e.key === 'Escape') {
          if (mathModal.classList.contains('show')) {
            hideMathModal();
          } else {
            toggleEarlyReturn();
          }
          e.preventDefault();
        }
        
        // Handle F key for focus mode
        if (e.key === 'f' || e.key === 'F') {
          toggleFocusMode();
          e.preventDefault();
        }
        
        // Block common escape shortcuts (but allow our custom ones)
        if (
          e.key === 'F4' && e.altKey ||
          e.key === 'Tab' && e.altKey ||
          e.key === 'Tab' && e.ctrlKey
        ) {
          e.preventDefault();
        }
      });

      // Prevent context menu
      document.addEventListener('contextmenu', (e) => e.preventDefault());

      // Prevent text selection
      document.addEventListener('selectstart', (e) => e.preventDefault());

      // Try to get break duration from local storage or URL params
      function getBreakDuration() {
        try {
          // Try to get from URL params first
          const urlParams = new URLSearchParams(window.location.search);
          const duration = urlParams.get('duration');
          if (duration) {
            return parseInt(duration);
          }
          
          // Fallback to localStorage
          const stored = localStorage.getItem('breakDuration');
          if (stored) {
            return parseInt(stored);
          }
        } catch (error) {
          console.error('Error getting break duration:', error);
        }
        
        // Default to 5 minutes
        return 300;
      }

      // Ensure fullscreen coverage
      function ensureFullscreen() {
        // Force the document to fill the entire viewport
        document.documentElement.style.width = '100vw';
        document.documentElement.style.height = '100vh';
        document.documentElement.style.overflow = 'hidden';
        document.documentElement.style.margin = '0';
        document.documentElement.style.padding = '0';
        document.documentElement.style.background = '#000';
        
        document.body.style.width = '100vw';
        document.body.style.height = '100vh';
        document.body.style.overflow = 'hidden';
        document.body.style.margin = '0';
        document.body.style.padding = '0';
        document.body.style.background = '#000';
        
        console.log('Fullscreen coverage ensured');
      }

      // Initialize the break screen
      function init() {
        ensureFullscreen();
        
        totalSeconds = getBreakDuration();
        currentSeconds = totalSeconds;
        
        initProgressCircle();
        updateCountdown();
        
        // Start timer after a short delay
        setTimeout(startTimer, 500);
        
        console.log(`Break timer initialized: ${totalSeconds} seconds`);
        console.log('Controls: F = toggle focus mode, ESC = toggle early return');
      }

      // Start everything when the page loads
      window.addEventListener('DOMContentLoaded', init);
      
      // Handle window resize to maintain fullscreen
      window.addEventListener('resize', ensureFullscreen);
    </script>
  </body>
</html>
